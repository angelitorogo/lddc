<section class="map-page">
  <header class="map-page__header">
    <div>
      <h1 class="map-page__title">Mapa de rutas</h1>
      <p class="map-page__subtitle">
        Mueve el mapa o haz zoom para cargar rutas dentro del viewport.
      </p>
    </div>

    <div class="map-page__actions">
      <button
        class="btn btn--secondary"
        [title]="isMapExpanded ? 'Contraer mapa' : 'Expandir mapa'"
        (click)="toggleMapExpanded()"
      >
        <i class="bi" [ngClass]="isMapExpanded ? 'bi-fullscreen-exit' : 'bi-fullscreen'"></i>
      </button>
      <button
        class="btn btn--secondary"
        [disabled]="viewportTracks.length === 0"
        [title]="showViewportPolylines ? 'Ocultar polilíneas' : 'Mostrar polilíneas'"
        (click)="toggleViewportPolylinesButton()"
      >
        <i class="bi" [ngClass]="showViewportPolylines ? 'bi-eye' : 'bi-eye-slash'"></i>
      </button>
      <button class="btn btn--secondary" title="Localizar" (click)="toggleMyLocation()">
        <i class="bi" [ngClass]="isMyLocationEnabled ? 'bi-geo-alt-fill' : 'bi-geo-alt'"></i>
      </button>
      <button class="btn btn--secondary" title="Centrar" (click)="recenter()"><i class="bi bi-bullseye"></i></button>
      <button class="btn btn--primary" title="Actualizar" (click)="refresh()">Actualizar</button>
    </div>
  </header>

  <!--<div class="ad-block" *ngIf="cookiePrefs.hasConsent('ads')">
    <app-manual-ad adSlot="1111111111"></app-manual-ad>
  </div>-->

  <section class="split" [class.split--expanded]="isMapExpanded">
    <!-- IZQUIERDA: MAPA -->
    <section class="split__left map-panel">
      <div class="map-panel__topbar">
        <div class="pill">
          <span class="pill__label">Rutas</span>
          <span class="pill__value">{{ total }}</span>
        </div>

        <div class="pill">
          <span class="pill__label">Densidad</span>
          <span class="pill__value">{{ densityLabel }}</span>
        </div>

        <div class="warning" *ngIf="showHighDensityWarning && !loading && !error">
          Demasiadas rutas, haz zoom para ver más.
          <span class="warning__count">
            Mostrando {{ showingCount }} de {{ total }}
          </span>
        </div>

        <div class="status" *ngIf="loading">Cargando…</div>
        <div class="status status--error" *ngIf="!loading && error">{{ error }}</div>
      </div>

      <google-map
        #mapContainer
        class="map-panel__map"
        width="100%"
        [center]="center"
        [zoom]="zoom"
        [options]="options"
        (wheel)="onMouseWheel($event)"
        (mapIdle)="onIdle()"
        (mapDragend)="onDragEnd()"
      >

        <!-- ✅ Halo de precisión (tipo Google) -->
        <map-circle
          *ngIf="myLocation && myAccuracy"
          [center]="myLocation"
          [radius]="myAccuracy"
          [options]="myAccuracyCircleOptions"
        ></map-circle>

        <map-marker
          *ngIf="myLocation"
          [position]="myLocation"
          [icon]="myBlueDotIcon"
          title="Tu ubicación"
        ></map-marker>

        <ng-container *ngIf="showViewportPolylines">
          <map-polyline
            *ngFor="let pl of viewportPolylines; trackBy: trackByPolylineId"
            [path]="pl.path"
            [options]="viewportPolylineOptions"
          ></map-polyline>
        </ng-container>

        <!-- Base markers: si NO es hover, marker normal (sin icon input) -->
        <ng-container *ngFor="let m of markers; trackBy: trackByMarkerId">

          <!-- Normal -->
          <map-marker
            *ngIf="hoveredTrackId !== m.trackId"
            [position]="m.position"
            [title]="m.title"
            [icon]="pinNormalUrl"
            (mapClick)="onMarkerClick(m)"
            (mapMouseover)="onMarkerMouseOver(m.trackId)"
            (mapMouseout)="onMarkerMouseOut(m.trackId)"
          ></map-marker>

          <map-marker
            *ngIf="hoveredTrackId === m.trackId"
            [position]="m.position"
            [title]="m.title"
            [icon]="pinHoverUrl"
            (mapClick)="onMarkerClick(m)"
            (mapMouseover)="onMarkerMouseOver(m.trackId)"
            (mapMouseout)="onMarkerMouseOut(m.trackId)"
          ></map-marker>

          <!-- Polilínea SOLO en hover -->
          <map-polyline
            *ngIf="hoverPolylinePath.length > 1"
            [path]="hoverPolylinePath"
            [options]="hoverPolylineOptions"
          ></map-polyline>


        </ng-container>





      </google-map>


      <div class="map-panel__hint">
        Se muestran marcadores por el punto de inicio (startLat/startLon). Click en un marcador abre el detalle.
      </div>
    </section>

    <!-- DERECHA: LISTADO -->
    <aside class="split__right" *ngIf="!isMapExpanded">
      <div class="right-panel">
        <header class="right-panel__header">
          <h2 class="right-panel__title">Rutas en pantalla</h2>
          <label class="switch" title="Mostrar polilíneas de todas las rutas del viewport">
            <input
            [disabled]="viewportTracks.length === 0"
              type="checkbox"
              [checked]="showViewportPolylines"
              (change)="toggleViewportPolylines($event)"
            />
            <span class="switch__track"></span>
            <span class="switch__text">
              <i
                class="bi"
                [ngClass]="showViewportPolylines ? 'bi-eye' : 'bi-eye-slash'"
                aria-hidden="true"
              ></i>
            </span>
          </label>

          <span class="right-panel__badge">
            {{ viewportTracks.length }} en viewport
          </span>
        </header>

        <div class="right-panel__content">
          <div *ngIf="!loading && !error && viewportTracks.length === 0" class="right-panel__empty">
            No hay rutas en esta zona. Mueve el mapa o haz zoom.
          </div>

          <div *ngIf="!loading && !error" class="tracks-list--vertical">
            <app-card-track
              *ngFor="let track of viewportTracks; trackBy: trackById"
              [track]="track"
              [distanceToStart]="formatDistance(getDistanceToTrackStartMeters(track))"
              [class.track-card--hover]="hoveredTrackId === track.id"
              [attr.id]="'track-card-' + track.id"
              (mouseenter)="onCardEnter(track.id)"
              (mouseleave)="onCardLeave(track.id)"
              (openDetail)="onOpenDetailFromMap($event)"
            ></app-card-track>
          </div>

          <div *ngIf="loading" class="right-panel__loading">
            Cargando rutas…
          </div>

          <div *ngIf="!loading && error" class="right-panel__error">
            {{ error }}
          </div>
        </div>
      </div>
    </aside>
  </section>
</section>
