<!-- src/app/dashboard/components/track-create/track-create.component.html -->

<section class="track-create">
  <header class="track-create__header">
    <button type="button" class="track-create__back" (click)="onBack()">
      <i class="bi bi-arrow-left"></i>
      <span>Volver</span>
    </button>

    <h1 class="track-create__title">Crear nueva ruta</h1>
    <p class="track-create__subtitle">
      Sube un archivo GPX y revisa el trazado en el mapa antes de guardar el track.
    </p>

    <!-- ✅ selector modo -->
    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;" *ngIf="authService.isLoggedIn() && authService.user.role == 'ADMIN'">
      <button
        type="button"
        class="btn-secondary"
        [disabled]="creating || bulkUploading"
        (click)="setBulkMode(false)"
        [style.opacity]="bulkMode ? 0.65 : 1"
      >
        Crear 1 track
      </button>

      <button
        type="button"
        class="btn-secondary"
        [disabled]="creating || bulkUploading"
        (click)="setBulkMode(true)"
        [style.opacity]="bulkMode ? 1 : 0.65"
      >
        Importación masiva (varios GPX)
      </button>
    </div>
  </header>

  <!-- =========================
       ✅ MODO BULK
       ========================= -->
  <section *ngIf="bulkMode" class="track-create__form">
    <!-- input oculto bulk -->
    <input
      #bulkGpxInput
      type="file"
      accept=".gpx"
      multiple
      style="display: none"
      (change)="onBulkFilesSelected($event)"
    />

    <div class="form-field">
      <label>Importación masiva</label>

      <div class="file-input-row" style="align-items: center; gap: 10px;">
        <button
          type="button"
          class="btn-upload"
          (click)="openBulkDialog()"
          [disabled]="bulkUploading"
        >
          <i class="bi bi-upload"></i>
          <span>Seleccionar GPX</span>
        </button>

        <span class="file-input__filename" *ngIf="bulkFiles.length">
          {{ bulkFiles.length }} GPX seleccionado(s)
        </span>

        <button
          type="button"
          class="btn-secondary"
          (click)="cancelBulk()"
          [disabled]="(!bulkFiles.length && !bulkJobId) || bulkUploading"
        >
          Quitar selección
        </button>

        <button
          type="button"
          class="btn-primary btn-primary--action"
          *ngIf="bulkFiles.length"
          (click)="uploadBulk()"
          [disabled]="bulkUploading"
        >
          <span class="btn-spinner" *ngIf="bulkUploading" aria-hidden="true"></span>
          {{ bulkUploading ? 'Procesando...' : ('Enviar ' + bulkFiles.length + ' GPX') }}
        </button>
      </div>

      <p class="form-field__hint">
        En importación masiva no se piden nombres ni imágenes: el nombre del track se toma del nombre del archivo GPX.
      </p>

      <div class="form-field__error" *ngIf="fileError">
        {{ fileError }}
      </div>

      <div *ngIf="bulkUploading" style="margin-top: 8px; opacity:.9;">
        {{ bulkProgressText }}
      </div>
    </div>

    <div class="track-create__actions">
      <button
        type="button"
        class="btn-primary btn-primary--action"
        (click)="onBack()"
        [disabled]="bulkUploading"
      >
        Volver
      </button>
    </div>
  </section>

  <!-- =========================
       ✅ MODO NORMAL (tu form)
       ========================= -->
  <form *ngIf="!bulkMode" class="track-create__form" [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- NOMBRE -->
    <div class="form-field">
      <label for="name">Nombre *</label>
      <input id="name" type="text" formControlName="name" placeholder="P. ej. Circular a la Peña X..." />
      <div class="form-field__error" *ngIf="form.get('name')?.touched && form.get('name')?.invalid">
        El nombre es obligatorio.
      </div>
    </div>

    <!-- DESCRIPCIÓN -->
    <div class="form-field">
      <label for="description">Descripción (opcional)</label>
      <textarea
        id="description"
        rows="8"
        formControlName="description"
        placeholder="Aquí puedes escribir una descripción narrativa de la ruta..."
      ></textarea>
    </div>

    <!-- ARCHIVO GPX -->
    <div class="form-field">
      <label for="gpxFile">Archivo GPX</label>

      <div class="file-input-row">
        <input
          #fileInput
          id="gpxFile"
          type="file"
          accept=".gpx"
          (change)="onFileSelected($event)"
          class="file-input__hidden"
        />

        <button type="button" class="btn-upload" (click)="openFileDialog()" [disabled]="creating">
          <i class="bi bi-upload"></i>
          <span>{{ selectedFile ? 'Cambiar archivo' : 'Seleccionar GPX' }}</span>
        </button>

        <span class="file-input__filename" *ngIf="selectedFile">{{ selectedFile.name }}</span>

        <button type="button" class="btn-secondary" (click)="onCancelFile()" [disabled]="!selectedFile || creating">
          Quitar archivo
        </button>
      </div>

      <p class="form-field__hint">
        Selecciona un archivo .gpx para previsualizar el trazado en el mapa.
      </p>

      <div class="form-field__error" *ngIf="fileError">
        {{ fileError }}
      </div>

      <div class="form-field__info" *ngIf="selectedFile && !fileError">
        Archivo seleccionado: <strong>{{ selectedFile.name }}</strong>
      </div>
    </div>

    <!-- PREVIEW MAPA -->
    <section class="track-create__preview" *ngIf="isPreviewVisible">
      <h2 class="track-create__preview-title">Vista previa del track</h2>

      <div class="track-create__map-wrapper">
        <google-map height="360px" width="100%" [options]="mapOptions" (mapInitialized)="onMapReady($event)">
          <map-polyline [path]="previewPoints" [options]="polylineOptions"></map-polyline>
        </google-map>
      </div>

      <p class="track-create__preview-footnote">
        Si cambias de archivo GPX sin guardar, se actualizará esta vista previa.
      </p>
    </section>

    <!-- IMÁGENES -->
    <div class="form-field">
      <label for="imageFile">Imágenes</label>

      <div class="file-input-row">
        <input
          #imageInput
          id="imageFile"
          type="file"
          accept=".jpg, .jpeg, .png, .webp"
          multiple
          (change)="onImageSelected($event)"
          class="file-input__hidden"
        />

        <button type="button" class="btn-upload" (click)="openImageDialog()" [disabled]="creating">
          <i class="bi bi-upload"></i>
          <span>{{ selectedImages.length ? 'Cambiar imágenes' : 'Seleccionar imágenes' }}</span>
        </button>

        <span class="file-input__filename" *ngIf="selectedImages.length">
          {{ selectedImages.length }} imagen(es) seleccionada(s)
        </span>

        <button
          type="button"
          class="btn-secondary"
          (click)="onCancelImages()"
          [disabled]="!selectedImages.length || creating"
        >
          Quitar imágenes
        </button>
      </div>

      <div class="image-preview-grid" *ngIf="imagePreviews.length">
        <div class="image-preview-card" *ngFor="let img of imagePreviews; let i = index">
          <div class="image-preview-thumb">
            <img [src]="img.url" [alt]="img.file.name" />
          </div>
          <div class="image-preview-meta">
            <span class="image-preview-name" [title]="img.file.name">
              {{ img.file.name }}
            </span>
            <button type="button" class="image-preview-remove" (click)="removeImage(i)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ACCIONES -->
    <div class="track-create__actions">
      <button type="submit" class="btn-primary btn-primary--action" [disabled]="creating">
        <span class="btn-spinner" *ngIf="creating" aria-hidden="true"></span>
        {{ creating ? 'Creando...' : 'Crear track' }}
      </button>

      <button type="button" class="btn-primary btn-primary--action" (click)="onBack()" [disabled]="creating">
        Cancelar
      </button>
    </div>
  </form>
</section>
