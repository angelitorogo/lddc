<!-- src/app/dashboard/components/track-create/track-create.component.html -->

<section class="track-create">
  <header class="track-create__header">
    <button type="button" class="track-create__back" (click)="onBack()">
      <i class="bi bi-arrow-left"></i>
      <span>Volver</span>
    </button>

    <h1 class="track-create__title">Crear nueva ruta</h1>
    <p class="track-create__subtitle">
      Sube un archivo GPX y revisa el trazado en el mapa antes de guardar el track.
    </p>
  </header>

  <form class="track-create__form" [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- NOMBRE -->
    <div class="form-field">
      <label for="name">Nombre de la ruta *</label>
      <input id="name" type="text" formControlName="name" placeholder="P. ej. Circular a la Peña X..." />
      <div class="form-field__error" *ngIf="form.get('name')?.touched && form.get('name')?.invalid">
        El nombre es obligatorio.
      </div>
    </div>

    <!-- DESCRIPCIÓN -->
    <div class="form-field">
      <label for="description">Descripción (opcional)</label>
      <textarea id="description" rows="4" formControlName="description"
        placeholder="Aquí puedes escribir una descripción narrativa de la ruta..."></textarea>
    </div>

    <!-- ARCHIVO GPX -->
    <div class="form-field">
      <label for="gpxFile">Archivo GPX</label>

      <div class="file-input-row">

        <!-- INPUT REAL OCULTO -->
        <input #fileInput id="gpxFile" type="file" accept=".gpx" (change)="onFileSelected($event)"
          class="file-input__hidden" />

        <!-- BOTÓN PERSONALIZADO -->
        <button type="button" class="btn-upload" (click)="openFileDialog()">
          <i class="bi bi-upload"></i>
          <span>
            {{ selectedFile ? 'Cambiar archivo' : 'Seleccionar GPX' }}
          </span>
        </button>

        <!-- MOSTRAR NOMBRE DEL ARCHIVO -->
        <span class="file-input__filename" *ngIf="selectedFile">
          {{ selectedFile.name }}
        </span>

        <!-- BOTÓN QUITAR ARCHIVO -->
        <button type="button" class="btn-secondary" (click)="onCancelFile()" [disabled]="!selectedFile">
          Quitar archivo
        </button>

      </div>


      <p class="form-field__hint">
        Selecciona un archivo .gpx para previsualizar el trazado en el mapa.
      </p>

      <div class="form-field__error" *ngIf="fileError">
        {{ fileError }}
      </div>

      <div class="form-field__info" *ngIf="selectedFile && !fileError">
        Archivo seleccionado: <strong>{{ selectedFile.name }}</strong>
      </div>
    </div>

    <!-- PREVIEW MAPA -->
    <section class="track-create__preview" *ngIf="isPreviewVisible">
      <h2 class="track-create__preview-title">Vista previa del track</h2>

      <div class="track-create__map-wrapper">
        <google-map height="360px" width="100%" [options]="mapOptions" (mapInitialized)="onMapReady($event)">
          <map-polyline [path]="previewPoints" [options]="polylineOptions"></map-polyline>
        </google-map>
      </div>

      <p class="track-create__preview-footnote">
        Si cambias de archivo GPX sin guardar, se actualizará esta vista previa.
      </p>
    </section>

    <!-- IMÁGENES -->
    <div class="form-field">
      <label for="imageFile">Imágenes</label>

      <div class="file-input-row">
        <!-- INPUT IMAGES REAL OCULTO -->
        <input #imageInput id="imageFile" type="file" accept=".jpg, .jpeg, .png, .webp" multiple
          (change)="onImageSelected($event)" class="file-input__hidden" />

        <!-- BOTÓN PERSONALIZADO -->
        <button type="button" class="btn-upload" (click)="openImageDialog()">
          <i class="bi bi-upload"></i>
          <span>
            {{ selectedImages.length ? 'Cambiar imágenes' : 'Seleccionar imágenes' }}
          </span>
        </button>

        <!-- RESUMEN -->
        <span class="file-input__filename" *ngIf="selectedImages.length">
          {{ selectedImages.length }} imagen(es) seleccionada(s)
        </span>

        <!-- BOTÓN QUITAR IMÁGENES -->
        <button type="button" class="btn-secondary" (click)="onCancelImages()" [disabled]="!selectedImages.length">
          Quitar imágenes
        </button>
      </div>

      <!-- PREVIEW DE IMÁGENES -->
      <div class="image-preview-grid" *ngIf="imagePreviews.length">
        <div class="image-preview-card" *ngFor="let img of imagePreviews; let i = index">
          <div class="image-preview-thumb">
            <img [src]="img.url" [alt]="img.file.name" />
          </div>
          <div class="image-preview-meta">
            <span class="image-preview-name" [title]="img.file.name">
              {{ img.file.name }}
            </span>
            <button type="button" class="image-preview-remove" (click)="removeImage(i)">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- ACCIONES -->
    <div class="track-create__actions">
      <button type="button" class="btn-secondary" (click)="onBack()">
        Cancelar
      </button>

      <button type="submit" class="btn-primary">
        Crear track
      </button>
    </div>
  </form>
</section>