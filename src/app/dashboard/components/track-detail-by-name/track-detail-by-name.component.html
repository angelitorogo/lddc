<section class="track-page" *ngIf="track">
  <!-- HEADER -->
  <header class="track-page__header">
    <button class="track-page__back" type="button" (click)="onBack()">
      <i class="bi bi-arrow-left"></i>
      <span>Volver</span>
    </button>

    <div class="track-page__header-main">
      <h1 class="track-page__title">
        {{ track.name }}
      </h1>
      <p class="track-page__subtitle">
        - {{ getRouteTypeLabel() }}
      </p>
    </div>

    <div class="track-page__chips">
      <span
        class="track-detail__difficulty"
        [ngClass]="getDifficultyClass()"
        *ngIf="track.difficulty"
      >
        {{ getDifficultyLabel() }}
      </span>

      <span class="track-page__chip" *ngIf="track.totalDistanceMeters">
        {{ (track.totalDistanceMeters / 1000) | number : '1.1-1' }} km
      </span>

      <span class="track-page__chip" *ngIf="track.totalAscent">
        +{{ track.totalAscent | number : '1.0-0' }} m
      </span>

      <span class="track-page__chip" *ngIf="track.totalTimeSeconds">
        {{ getFormattedTime() }}
      </span>

      <span class="track-page__chip" *ngIf="track.dateTrack">
        {{ track.dateTrack | date : 'd/M/yyyy' }}
      </span>
    </div>
  </header>

  <!-- LAYOUT PRINCIPAL -->
  <div class="track-page__layout">

    <!-- PORTADA (col izquierda, fila 1) -->
    <section class="track-panel track-page__cover" *ngIf="polylinePath.length">
      <figure class="track-page__cover-figure track-page__cover-figure--map">
        <google-map
          #detailMap
          [height]="isMobileView ? '277px' : '460px'"
          width="100%"
          [center]="mapCenter || { lat: 0, lng: 0 }"
          [zoom]="mapZoom"
          [options]="mapOptions"
        >
          <map-polyline [path]="polylinePath" [options]="polylineOptions" (polylineClick)="onTrackPolylineClick($event)"></map-polyline>

          <map-marker
            *ngIf="startMarkerPos"
            [position]="startMarkerPos"
            [options]="startMarkerOptions">
          </map-marker>

          <map-marker
            *ngIf="endMarkerPos"
            [position]="endMarkerPos"
            [options]="endMarkerOptions">
          </map-marker>
          
          <map-marker
            *ngIf="hoverMapPoint"
            [position]="hoverMapPoint"
            [options]="hoverMarkerOptions"
          ></map-marker>

          <!-- ✅ POIs: solo marcadores, sin click -->
          <ng-container *ngIf="showPois">
            <map-marker
              *ngFor="let m of poiMarkers; trackBy: trackByPoiId"
              [position]="m.position"
              [options]="m.options"
              (mapClick)="onWaypointMarkerClick(m.data)"
            ></map-marker>
          </ng-container>
        </google-map>
      </figure>
      <!--<div class="map-attribution">
        POIs © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">
          OpenStreetMap contributors
        </a>
      </div>-->
    </section>

    <!-- COLUMNA DERECHA (fila 1): resumen + galería -->
    <div class="track-page__side">

      <section class="track-panel track-panel__user-avatar">
        <div class="user-data">
          <p class="user_data__text">Creador: <span (click)="showProfile()">{{user?.fullname}}</span></p>
        </div>     
      </section>

      <!-- RESUMEN / STATS -->
      <section class="track-panel track-page__summary">
        <h2 class="track-panel__title">Resumen de la ruta</h2>

        <div class="track-page__stats-grid">
          <div class="track-page__stat">
            <span class="track-page__stat-label">Tipo</span>
            <span class="track-page__stat-value">{{ getRouteTypeLabel() }}</span>
          </div>

          <div class="track-page__stat" *ngIf="track.totalDistanceMeters">
            <span class="track-page__stat-label">Distancia</span>
            <span class="track-page__stat-value">
              {{ (track.totalDistanceMeters / 1000) | number : '1.1-1' }} km
            </span>
          </div>

          <div class="track-page__stat" *ngIf="track.totalAscent">
            <span class="track-page__stat-label">Desnivel positivo</span>
            <span class="track-page__stat-value">
              {{ track.totalAscent | number : '1.0-0' }} m
            </span>
          </div>

          <div class="track-page__stat" *ngIf="track.totalDescent">
            <span class="track-page__stat-label">Desnivel negativo</span>
            <span class="track-page__stat-value">
              {{ track.totalDescent | number : '1.0-0' }} m
            </span>
          </div>

          <div class="track-page__stat" *ngIf="track.totalTimeSeconds">
            <span class="track-page__stat-label">Tiempo estimado</span>
            <span class="track-page__stat-value">
              {{ getFormattedTime() }}
            </span>
          </div>

          <div class="track-page__stat" *ngIf="track.difficulty">
            <span class="track-page__stat-label">Dificultad</span>
            <span class="track-page__stat-value">
              {{ getDifficultyLabel() }}
            </span>
          </div>
        </div>

        <div class="actions_panel">
          <a class="btn-outline track-page__footer-btn btn-follow" (click)="onClickFollow()">
            <i class="bi bi-signpost-2"></i>
            Seguir
          </a>
        </div>

      </section>

      <!-- GALERÍA SECUNDARIA -->
      <section
        class="track-panel track-page__gallery"
        *ngIf="track.images && track.images.length > 1"
      >
        <h2 class="track-panel__title">Imágenes de la ruta</h2>

        <div class="track-page__thumbs-row">
          <ng-container *ngFor="let image of track.images | slice:1; let i = index">
            <figure
              class="track-page__thumb-card"
              role="button"
              tabindex="0"
              (click)="openGallery(i + 1)"
              (keydown.enter)="openGallery(i + 1)"
              (keydown.space)="openGallery(i + 1)"
            >
              <img
                [src]="getUrlImage(image)"
                [alt]="track.name || 'Imagen de la ruta'"
                loading="lazy"
              />
            </figure>
          </ng-container>
        </div>
      </section>

      <!-- Placeholder cuando no hay ninguna imagen -->
      <section
        class="track-panel track-page__gallery track-page__gallery--empty"
        *ngIf="!track.images || track.images.length === 1"
      >
        <h2 class="track-panel__title">Imágenes de la ruta</h2>
        <p class="track-page__description-text track-page__description-text--muted">
          Esta ruta todavía no tiene fotos asociadas.
        </p>
        <div class="track-panel__button" *ngIf="authService.user?.id === track.authorUserId">
          <button
            type="button"
            class="btn-outline track-page__footer-btn"
            (click)="onEditTrack()"
          >
            <i class="bi bi-pencil"></i>
            <span>Añadir imágenes</span>
          </button>
        </div>
      </section>
    </div>

    <!-- FILA 2: PERFIL DE ELEVACIÓN -->
    <section class="track-panel track-page__profile">
      <h2 class="track-panel__title title__perfil">
        <span>Perfil</span>

        <div class="track-panel__poi_pend">
          <span class="track-panel__pend" *ngIf="pendiente">
            {{isMobileView ? '' : 'Pendiente'}}
            <span class="slope" [ngClass]="getSlopeClass(+pendiente!)">{{ pendiente }}%</span>
          </span>
          <button class="poi-toggle" type="button" (click)="toggleAddWaypointMode()">
            <i class="bi bi-plus-circle"></i>
            {{ isAddWaypointMode ? 'Cancelar' : isMobileView ? 'Añadir WP' : 'Añadir waypoint' }}
          </button>
          <button
            type="button"
            *ngIf="track.waypoints.length > 0"
            class="poi-toggle"
            (click)="togglePois()"
            [attr.aria-pressed]="showPois"
          >
            <i class="bi" [ngClass]="showPois ? 'bi-geo-alt-fill' : 'bi-geo-alt'"></i>
            <span>{{ showPois ? 'Ocultar WayPoints' : isMobileView ? 'Mostrar WP' : 'Mostrar WayPoints' }}</span>
          </button>
        </div>
       
      </h2>

      <div
        class="track-page__profile-chart"
        #profileWrap
        (mouseleave)="onProfileLeave()"
        (touchstart)="onProfileTouch($event)"
        (touchmove)="onProfileTouch($event)"
        (touchend)="onProfileLeave()"
      >
        <canvas #elevationCanvas (mouseout)="onProfileLeave()"></canvas>

        <div
          class="elev-tooltip-up"
          #tooltipUpEl
          *ngIf="elevTooltip.visible && !this.isMobileView"
          [style.left.px]="elevTooltip.x"
          [style.top.px]="elevTooltip.y"
        >
          <div class="elev-tooltip__row">
            <span class="elev-tooltip__label">Altitud</span>
            <span class="elev-tooltip__value">
              {{ elevTooltip.altitudeM | number : '1.0-0' }} m
            </span>
          </div>
        </div>

        <div
          class="elev-tooltip-down"
          #tooltipDownEl
          *ngIf="elevTooltip.visible"
          [style.left.px]="elevTooltip.x"
          [style.top.px]="elevTooltip.y"
        >
          <div class="elev-tooltip__row" *ngIf="this.isMobileView">
            <span class="elev-tooltip__label">Altitud</span>
            <span class="elev-tooltip__value">
              {{ elevTooltip.altitudeM | number : '1.0-0' }} m
            </span>
          </div>

          <div class="elev-tooltip__row">
            <span class="elev-tooltip__label">Distancia</span>
            <span class="elev-tooltip__value">
              {{ elevTooltip.distanceKm | number : '1.2-2' }} km
            </span>
          </div>

          <!-- ✅ NUEVO: POI -->
          <div class="elev-tooltip__row" *ngIf="hoverPoi">
            <span class="elev-tooltip__label">WP</span>
            <span class="elev-tooltip__value">
              {{ hoverPoi.name }}
            </span>
          </div>
        </div>
      </div>

      <p
        *ngIf="!hasElevationProfile()"
        class="track-page__description-text track-page__description-text--muted"
      >
        No hay suficientes datos de altitud para mostrar un perfil.
      </p>
      <!-- ATRIBUCIÓN OSM -->
        <!--<div class="track-page__attribution">
          <i class="bi bi-info-circle"></i>
          <span>
            POIs © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">
              OpenStreetMap contributors
            </a>
          </span>
        </div>-->
    </section>

    <!-- FILA 3: DESCRIPCIÓN -->
    <section class="track-panel track-page__description">
      <h2 class="track-panel__title">Descripción</h2>

      <ng-container *ngIf="track.description; else noDescription">
        <div
          class="track-page__description-wrapper"
          [class.track-page__description-wrapper--expanded]="isDescriptionExpanded"
        >
          <textarea
            #descTa
            class="track-page__description-text"
            rows="8"
            readonly
            [value]="track.description"
          ></textarea>

          <div class="track-page__description-fade" *ngIf="!isDescriptionExpanded"></div>
        </div>

        <button
          type="button"
          class="btn-link track-page__description-toggle"
          (click)="toggleDescription()"
        >
          {{ isDescriptionExpanded ? 'Ver menos' : 'Ver descripción completa' }}
        </button>
      </ng-container>

      <ng-template #noDescription>
        <p class="track-page__description-text track-page__description-text--muted">
          Esta ruta aún no tiene una descripción detallada.
        </p>
        <div class="track-panel__button" *ngIf="authService.user?.id === track.authorUserId">
          <button
            type="button"
            class="btn-outline track-page__footer-btn"
            (click)="onEditTrack()"
          >
            <i class="bi bi-pencil"></i>
            <span>Añadir descripción</span>
          </button>
        </div>
      </ng-template>
    </section>

    <!-- FILA 4: RUTAS CERCANAS -->
    <section class="track-panel track-page__nearby" *ngIf="track">
      <div class="track-page__nearby-header">
        <h2 class="track-panel__title">Rutas cercanas</h2>

        <span class="track-page__nearby-muted" *ngIf="isLoadingNearby">
          Cargando...
        </span>
      </div>

      <p class="track-page__description-text track-page__description-text--muted" *ngIf="nearbyError">
        {{ nearbyError }}
      </p>

      <p
        class="track-page__description-text track-page__description-text--muted"
        *ngIf="!isLoadingNearby && !nearbyError && (!nearbyTracks || nearbyTracks.length === 0)"
      >
        No hay rutas cercanas disponibles para este punto.
      </p>

      <div class="nearby-row" *ngIf="!isLoadingNearby && nearbyTracks && nearbyTracks.length > 0">
        <article
          class="nearby-card"
          *ngFor="let t of nearbyTracks"
          (click)="navigateNearbyTrack(t)"
          role="button"
          tabindex="0"
        >
          <div class="nearby-card__img">
            <img
              *ngIf="t.images?.length"
              [src]="getUrlImage(t.images[0])"
              [alt]="t.name || 'Ruta cercana'"
            />
            <div class="nearby-card__img-placeholder" *ngIf="!t.images?.length">
              Sin foto
            </div>

            <span class="nearby-card__badge" *ngIf="t.distanceMeters != null">
              a {{ (t.distanceMeters / 1000) | number:'1.1-1' }} km
            </span>
          </div>

          <div class="nearby-card__body">
            <div class="nearby-card__title" [title]="t.name">{{ t.name }}</div>

            <div class="nearby-card__meta">
              <span *ngIf="t.totalDistanceMeters">
                {{ (t.totalDistanceMeters / 1000) | number:'1.1-1' }} km
              </span>
              <span *ngIf="t.totalAscent">
                +{{ t.totalAscent | number:'1.0-0' }} m
              </span>
              <span *ngIf="t.dateTrack">
                {{ t.dateTrack | date:'d/M/yyyy' }}
              </span>
            </div>
          </div>
        </article>
      </div>
    </section>
  </div>

  <!-- ===== Lightbox ===== -->
  <div
    class="lightbox"
    *ngIf="isGalleryOpen"
    (click)="closeGallery()"
    role="dialog"
    aria-modal="true"
  >
    <div class="lightbox__panel" (click)="$event.stopPropagation()">
      <button class="lightbox__close" type="button" (click)="closeGallery()" aria-label="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>

      <button
        class="lightbox__nav lightbox__nav--prev"
        type="button"
        (click)="prevImage()"
        [disabled]="!hasPrevImage()"
        aria-label="Anterior"
      >
        <i class="bi bi-chevron-left"></i>
      </button>

      <div
        class="lightbox__stage"
        (touchstart)="onLightboxTouchStart($event)"
        (touchmove)="onLightboxTouchMove($event)"
        (touchend)="onLightboxTouchEnd()"
      >
        <img
          class="lightbox__img"
          [src]="getUrlImage(track!.images[galleryIndex])"
          [alt]="track.name || 'Imagen de la ruta'"
        />

        <div class="lightbox__counter" *ngIf="track.images.length">
          {{ galleryIndex }} / {{ track!.images.length - 1 }}
        </div>
      </div>

      <button
        class="lightbox__nav lightbox__nav--next"
        type="button"
        (click)="nextImage()"
        [disabled]="!hasNextImage()"
        aria-label="Siguiente"
      >
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- FOOTER DE ACCIONES -->
  <footer class="track-page__footer">
    <button
      type="button"
      class="btn-outline track-page__footer-btn"
      (click)="onDownloadGpx()"
      *ngIf="authService.user"
    >
      <i class="bi bi-download"></i>
      <span>Descarga GPX</span>
    </button>

    <button type="button" class="btn-outline track-page__footer-btn" (click)="onCopyLink()">
      <i class="bi bi-link-45deg"></i>
      <span>Copiar enlace</span>
    </button>

    <button type="button" class="btn-outline track-page__footer-btn" (click)="onShareLink()">
      <i class="bi bi-share"></i>
      <span>Compartir</span>
    </button>

    <button
      type="button"
      class="btn-outline track-page__footer-btn"
      (click)="onEditTrack()"
      *ngIf="authService.user?.id === track.authorUserId"
    >
      <i class="bi bi-pencil"></i>
      <span>Editar ruta</span>
    </button>

    <button
      type="button"
      class="btn-danger track-page__footer-btn"
      (click)="openDeleteTrackModal()"
      *ngIf="authService.user?.id === track.authorUserId"
    >
      <i class="bi bi-trash"></i>
      <span>Eliminar ruta</span>
    </button>

    <!-- MODAL CONFIRM (ELIMINAR RUTA) -->
    <div class="modal" *ngIf="confirmDeleteOpen" (click)="cancelDelete()">
      <div class="modal__panel" (click)="$event.stopPropagation()">
        <h3 class="modal__title">{{ titleModal }}</h3>

        <p class="modal__text">
          {{ textModal }}
        </p>

        <div class="modal__actions" *ngIf="typeModal === 'DELETE'">
          <button class="btn-outline track-modal-btn" (click)="cancelDelete()">Cancelar</button>
          <button class="btn-danger track-modal-btn" (click)="confirmDelete()">Eliminar</button>
        </div>

        <div class="modal__actions" *ngIf="typeModal === 'SUCCESS'">
          <button class="btn-outline track-modal-btn" (click)="successOk()">Aceptar</button>
        </div>
      </div>
    </div>

  </footer>
</section>



<!-- ✅ MODAL WAYPOINT (ver / editar) -->
<div
  class="wp-modal__backdrop"
  *ngIf="waypointModalOpen"
  (click)="closeWaypointModal()"
>
  <div class="wp-modal" (click)="$event.stopPropagation()" *ngIf="selectedWaypoint as wp">
    <div class="wp-modal__header">
      <div class="wp-modal__title">
        {{ (isEditingWaypoint ? (editWp.name || 'Waypoint') : (wp.name || 'Waypoint')) }}
      </div>

      <div class="wp-modal__header-actions">
        <!-- Editar (solo si NO estás editando) -->
        <button
          class="wp-modal__btn wp-modal__btn--edit"
          type="button"
          *ngIf="!isEditingWaypoint && authService.user?.id === track!.authorUserId"
          (click)="startEditWaypoint()"
        >
          <i class="bi bi-pencil"></i>
          Editar
        </button>

        <!-- Guardar (solo si estás editando) -->
        <button
          class="wp-modal__btn wp-modal__btn--save"
          type="button"
          *ngIf="isEditingWaypoint"
          (click)="saveWaypointEdit()"
        >
          <i class="bi bi-check2"></i>
          Guardar
        </button>

        <!-- Cerrar (siempre) -->
        <button
          class="wp-modal__close"
          type="button"
          (click)="closeWaypointModal()"
        >
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>

    <div class="wp-modal__body">
      <!-- =========================
           MODO LECTURA
      ========================== -->
      <ng-container *ngIf="!isEditingWaypoint; else editMode">
        <div class="wp-modal__row">
          <span class="wp-modal__label">Tipo</span>
          <span class="wp-modal__value">
            {{ wp.type }}
          </span>
        </div>

        <div class="wp-modal__row" *ngIf="wp.ele != null">
          <span class="wp-modal__label">Altitud</span>
          <span class="wp-modal__value">{{ wp.ele | number:'1.0-0' }} m</span>
        </div>

        <div class="wp-modal__row">
          <span class="wp-modal__label">Lat/Lon</span>
          <span class="wp-modal__value">
            {{ wp.lat | number:'1.6-6' }}, {{ wp.lon | number:'1.6-6' }}
          </span>
        </div>

        <div class="wp-modal__row" *ngIf="wp.time">
          <span class="wp-modal__label">Hora</span>
          <span class="wp-modal__value">
            {{ wp.time | date:'d/M/yyyy HH:mm' }}
          </span>
        </div>

        <div class="wp-modal__row" *ngIf="wp.desc">
          <span class="wp-modal__label">Descripción</span>
          <span class="wp-modal__value wp-modal__value--multiline">{{ wp.desc }}</span>
        </div>

        <div class="wp-modal__row" *ngIf="wp.cmt">
          <span class="wp-modal__label">Comentario</span>
          <span class="wp-modal__value wp-modal__value--multiline">{{ wp.cmt }}</span>
        </div>
      </ng-container>

      <!-- =========================
           MODO EDICIÓN
      ========================== -->
      <ng-template #editMode>
        <div class="wp-form">
          <div class="wp-form__field">
            <label class="wp-form__label">Lat</label>
            <input
              class="wp-form__input wp-form__input--readonly"
              type="text"
              [ngModel]="editWp.lat"
              readonly
            />
          </div>

          <div class="wp-form__field">
            <label class="wp-form__label">Lon</label>
            <input
              class="wp-form__input wp-form__input--readonly"
              type="text"
              [ngModel]="editWp.lon"
              readonly
            />
          </div>

          <div class="wp-form__field">
            <label class="wp-form__label">Ele (m)</label>
            <input
              class="wp-form__input wp-form__input--readonly"
              type="text"
              [ngModel]="editWp.ele"
              readonly
            />
          </div>

          <div class="wp-form__field">
            <label class="wp-form__label">Nombre</label>
            <input
              class="wp-form__input"
              type="text"
              [(ngModel)]="editWp.name"
              placeholder="Nombre del waypoint"
            />
          </div>

          <div class="wp-form__field">
            <label class="wp-form__label">Tipo</label>
            <select class="wp-form__select" [(ngModel)]="editWp.type">
              <option value="DRINKING_WATER">DRINKING_WATER</option>
              <option value="VIEWPOINT">VIEWPOINT</option>
              <option value="SHELTER">SHELTER</option>
              <option value="PARKING">PARKING</option>
              <option value="CAMP_SITE">CAMP_SITE</option>
              <option value="PICNIC_SITE">PICNIC_SITE</option>
              <option value="INFORMATION">INFORMATION</option>
            </select>
          </div>

          <div class="wp-form__field">
            <label class="wp-form__label">Descripción</label>
            <textarea
              class="wp-form__textarea"
              rows="3"
              [(ngModel)]="editWp.desc"
              placeholder="Descripción (opcional)"
            ></textarea>
          </div>

          <div class="wp-form__field">
            <label class="wp-form__label">Comentario</label>
            <textarea
              class="wp-form__textarea"
              rows="3"
              [(ngModel)]="editWp.cmt"
              placeholder="Comentario (opcional)"
            ></textarea>
          </div>

          <div class="wp-form__hint">
            <i class="bi bi-info-circle"></i>
            Por ahora editas nombre, tipo, descripción y comentario.
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</div>



